service: warriorbeat-graphql

provider:
  name: aws
  runtime: python3.7
  stage: dev
  region: us-east-1

plugins:
  - serverless-python-requirements
  - serverless-appsync-plugin
  - serverless-dynamodb-local
  - serverless-appsync-offline
  - serverless-offline
  - aws-amplify-serverless-plugin

custom:
  stage: ${opt:stage, self:provider.stage}
  stack: warriorbeat-graphql-${self:custom.stage}
  tableThroughputs:
    prod: 5
    default: 1
  tableThroughput: ${self:custom.tableThroughputs.${self:custom.stage}, self:custom.tableThroughputs.default}
  accountId: '881433986874'
  # Python Runtime
  pythonRequirements:
    dockerizePip: true
    slim: true
    useDownloadCache: true
    useStaticCache: true
    zip: true
  # END PYTHON RUNTIME ===================

  # SLS Dev Env
  appsync-offline:
    port: 62222
    dynamodb:
      client:
        endpoint: 'http://localhost:8000'
        region: localhost
  dynamodb:
    start:
      port: 8000
      inMemory: true
      migrate: true
      seed: true
    seed:
      test:
        sources:
          - table: { Ref: PollTable }
            sources: [seed-data/polls.json]
          - table: { Ref: PollOptionsTable }
            sources: [seed-data/poll_options.json]
          - table: { Ref: PollVotesTable }
            sources: [seed-data/poll_votes.json]
  # END SLS DEV ENV ===================

  # AWS Amplify ===================
  amplify:
    - filename: amplify/aws-exports.js
      type: javascript
  # END AWS Amplify ===================

  # AppSync ===================
  appSync:
    name: WarriorBeatAppSync-${self:custom.stage}
    authenticationType: API_KEY
    schema:
      - schema/base.graphql
      - schema/polls.graphql
    mappingTemplates:
      - ${file(mapping-templates/polls/map.yml)}
    functionConfigurations:
      - ${file(mapping-templates/functions/polls.yml)}
    serviceRole: 'AppSyncServiceRole'
    dataSources:
      - ${file(schema/data/LambdaResolver.yml)}
      - ${file(schema/data/polls.yml)}
      - ${file(schema/data/none.yml)}

  # END AppSync ===================

resources:
  # AppSync Service/Handler Roles
  - ${file(resources/appsync-roles.yml)}
  # DynamoDB Tables
  - ${file(resources/tables/polls.yml)}
  - ${file(resources/tables/authors.yml)}
  - ${file(resources/tables/media.yml)}
  - ${file(resources/tables/articles.yml)}
  - ${file(resources/tables/users.yml)}
  # Cognito Pool
  - ${file(resources/cognito-pool.yml)}

package:
  exclude:
    - .git/**
    - .amplify/**
    - .seed-data/**
    - node_modules/**

functions:
  lambda_handler:
    handler: handler.lambda_handler
    role: 'AppSyncHandler'
